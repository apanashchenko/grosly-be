# PgBouncer connection pooler for spysko
app = "spysko-pgbouncer"
org = "spysko"
primary_region = "fra"

[build]
  image = "edoburu/pgbouncer:latest"

[env]
  # Connection to PostgreSQL (DB_HOST and DB_PASSWORD via secrets - IPv6 address)
  # DB_HOST is set via: fly secrets set DB_HOST="<postgres-ipv6>" -a spysko-pgbouncer
  DB_PORT = "5432"
  DB_NAME = "spysko"
  DB_USER = "postgres"

  # PgBouncer settings
  POOL_MODE = "transaction"
  MAX_CLIENT_CONN = "200"
  DEFAULT_POOL_SIZE = "20"
  MIN_POOL_SIZE = "5"
  RESERVE_POOL_SIZE = "10"
  RESERVE_POOL_TIMEOUT = "5"
  MAX_DB_CONNECTIONS = "80"

  # Auth
  AUTH_TYPE = "plain"

  # Timeouts
  SERVER_IDLE_TIMEOUT = "600"
  SERVER_LIFETIME = "3600"
  SERVER_CONNECT_TIMEOUT = "15"
  QUERY_TIMEOUT = "120"
  CLIENT_IDLE_TIMEOUT = "0"

  # Logging
  LOG_CONNECTIONS = "0"
  LOG_DISCONNECTIONS = "0"
  LOG_POOLER_ERRORS = "1"
  VERBOSE = "0"

  # Stats
  STATS_PERIOD = "60"

  # Listen on all interfaces
  LISTEN_ADDR = "*"
  LISTEN_PORT = "5432"

[[services]]
  internal_port = 5432
  protocol = "tcp"
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

  [[services.ports]]
    port = 5432

[[vm]]
  memory = "256mb"
  cpu_kind = "shared"
  cpus = 1
  count = 1
